<%
  // --- Start of JS logic ---

  // Set default values using modern JS.
  const defaults = {
    memorySize: 256,
    timeout: 30,
    runtime: 'nodejs20.x',
    handler: 'index.handler',
    logging: { retentionInDays: 7 },
    monitoring: { enabled: false }
  };

  // Merge manifest definitions with defaults
  const finalDef = { ...defaults, ...def };
  finalDef.logging = { ...defaults.logging, ...def.logging };
  finalDef.monitoring = { ...defaults.monitoring, ...def.monitoring };

  // --- End of JS logic ---
%>
# This file is generated by crustomize from a crustomize.yml.in template.
# Do not edit this file directly.

base: ./base

# These values are passed to the .ejs templates in the base directory
values:
  FunctionName: "<%= name %>"
  MemorySize: <%= finalDef.memorySize %>
  Timeout: <%= finalDef.timeout %>
  Runtime: "<%= finalDef.runtime %>"
  Handler: "<%= finalDef.handler %>"
  LogRetentionInDays: <%= finalDef.logging.retentionInDays %>
  MonitoringEnabled: <%= finalDef.monitoring.enabled %>

  # Pass complex objects as JSON strings. The EJS templates will parse them.
  VpcConfig: <%- JSON.stringify(def.vpcConfig || null) %>
  EnvironmentVariables: <%- JSON.stringify(def.environment || null) %>

# List of resources to merge. Order can be important.
resources:
  - Role.yml
  - Policy.yml
  - LogGroup.yml
  - Lambda.yml
  <% if (finalDef.monitoring.enabled) { %>
  - Monitoring.yml
  <% } %>
